{{template "dashboard/layouts/top" .}}

<main class="bg-white dark:bg-gray-900 py-8 px-4 mx-auto max-w-2xl lg:py-16">
    <!-- Screen 1: Batch and Program Selection -->
    <div id="screen1" class="block">
        <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Select Program And Semester</h2>
        <form id="formScreen1" class="space-y-4">
            <div>
                <label for="program" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Program</label>
                <select id="program_id" name="program_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                    required>
                    <option value="">Select Program</option>
                    {{range .Programs}}
                    <option value="{{.ID}}">{{.Name}}</option>
                    {{end}}
                </select>

            </div>

            <div>
                <label for="semester" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Semester</label>
                <select id="semester" name="semester_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                    required>
                    <option value="">Select Semester</option>
                </select>
            </div>
            <button type="button" onclick="nextScreen()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Next</button>
        </form>
    </div>

    <!-- Screen 2: Course Entry Form -->
    <div id="screen2" class="hidden w-full">
        <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Add Course</h2>
        <form id="formScreen2">
            <input type="hidden" id="program_id_hidden" name="program_id" value="">
            <input type="hidden" id="semester_hidden" name="semester_id" value="">
            <div class="overflow-x-auto mb-4">
                <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-800">
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Course Code</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Course Name</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Semester Pass Marks</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Practical Pass Marks</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Assistant Pass Marks</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Semester Total Marks</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Practical Total Marks</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left text-gray-900 dark:text-white">Assistant Total Marks</th>
                        </tr>
                    </thead>
                    <tbody id="courseTableBody">
                        <!-- Table rows will be added dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <input type="text" id="course_code" name="course_code" placeholder="Course Code" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex-1">
                    <input type="text" id="name" name="name" placeholder="Course Name" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex-1">
                    <input type="number" id="semester_pass_marks" name="semester_pass_marks" placeholder="Semester Pass Marks" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex-1">
                    <input type="number" id="practical_pass_marks" name="practical_pass_marks" placeholder="Practical Pass Marks" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex-1">
                    <input type="number" id="assistant_pass_marks" name="assistant_pass_marks" placeholder="Assistant Pass Marks" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex-1">
                    <input type="number" id="semester_total_marks" name="semester_total_marks" placeholder="Semester Total Marks" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex-1">
                    <input type="number" id="practical_total_marks" name="practical_total_marks" placeholder="Practical Total Marks" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="flex-1">
                    <input type="number" id="assistant_total_marks" name="assistant_total_marks" placeholder="Assistant Total Marks" class="w-full border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md px-4 py-2 bg-gray-50 dark:bg-gray-700 dark:text-white">
                </div>
            </div>
            <div class="mt-4">
                <button type="button" onclick="addCourse()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add Course</button>
            </div>
            <div class="mt-4">
                <button type="button" onclick="prevScreen()" class="mr-4 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-gray-500">Previous</button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Submit</button>
            </div>
        </form>
    </div>

    <script>
        let courses = [];

        function nextScreen() {
            const programId = document.getElementById('program_id').value;
            const semesterId = document.getElementById('semester').value;

            document.getElementById('program_id_hidden').value = programId;
            document.getElementById('semester_hidden').value = semesterId;

            document.getElementById('screen1').classList.add('hidden');
            document.getElementById('screen2').classList.remove('hidden');
        }

        function prevScreen() {
            document.getElementById('screen1').classList.remove('hidden');
            document.getElementById('screen2').classList.add('hidden');
        }

        function addCourse() {
            const courseCode = document.getElementById('course_code').value;
            const name = document.getElementById('name').value;
            const semesterPassMarks = document.getElementById('semester_pass_marks').value;
            const practicalPassMarks = document.getElementById('practical_pass_marks').value || null;
            const assistantPassMarks = document.getElementById('assistant_pass_marks').value || null;
            const semesterTotalMarks = document.getElementById('semester_total_marks').value;
            const practicalTotalMarks = document.getElementById('practical_total_marks').value || null;
            const assistantTotalMarks = document.getElementById('assistant_total_marks').value || null;

            if (!courseCode || !name || !semesterPassMarks || !semesterTotalMarks) {
                alert('Please fill in all required fields');
                return;
            }

            const course = {
                course_code: courseCode,
                name: name,
                semester_pass_marks: semesterPassMarks,
                practical_pass_marks: practicalPassMarks,
                assistant_pass_marks: assistantPassMarks,
                semester_total_marks: semesterTotalMarks,
                practical_total_marks: practicalTotalMarks,
                assistant_total_marks: assistantTotalMarks
            };

            courses.push(course);

            renderCourseTable();
            clearFormFields();
        }

        function renderCourseTable() {
            const tbody = document.getElementById('courseTableBody');
            tbody.innerHTML = '';

            courses.forEach((course, index) => {
                const row = `
                    <tr>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.course_code}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.semester_pass_marks}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.practical_pass_marks || '-'}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.assistant_pass_marks || '-'}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.semester_total_marks}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.practical_total_marks || '-'}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">${course.assistant_total_marks || '-'}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function clearFormFields() {
            document.getElementById('course_code').value = '';
            document.getElementById('name').value = '';
            document.getElementById('semester_pass_marks').value = '';
            document.getElementById('practical_pass_marks').value = '';
            document.getElementById('assistant_pass_marks').value = '';
            document.getElementById('semester_total_marks').value = '';
            document.getElementById('practical_total_marks').value = '';
            document.getElementById('assistant_total_marks').value = '';
        }

        document.getElementById('formScreen2').addEventListener('submit', function(event) {
            event.preventDefault();

            const programId = document.getElementById('program_id_hidden').value;
            const semesterId = document.getElementById('semester_hidden').value;

            const payload = {
                program_id: parseInt(programId),
                semester_id: parseInt(semesterId),
                courses: courses.map(course => ({
                    course_code: course.course_code,
                    name: course.name,
                    semester_pass_marks: parseInt(course.semester_pass_marks),
                    practical_pass_marks: course.practical_pass_marks ? parseInt(course.practical_pass_marks) : null,
                    assistant_pass_marks: course.assistant_pass_marks ? parseInt(course.assistant_pass_marks) : null,
                    semester_total_marks: parseInt(course.semester_total_marks),
                    practical_total_marks: course.practical_total_marks ? parseInt(course.practical_total_marks) : null,
                    assistant_total_marks: course.assistant_total_marks ? parseInt(course.assistant_total_marks) : null
                }))
            };

            fetch('/courses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);
                    alert('Courses created successfully');
                    courses = []; // Clear courses array after successful submission
                    renderCourseTable(); // Optionally update UI after successful submission
                    clearFormFields(); // Clear form fields after successful submission
                    prevScreen(); // Go back to screen 1 after successful submission
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while creating courses: ' + error.message);
                });
        });

        function fetchSemesters() {
            const programId = document.getElementById('program_id').value;
            console.log('Fetching semesters for program ID:', programId);

            fetch(`/getfiltersemesters?program_id=${programId}`)
                .then(response => {
                    console.log('Semesters response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const semesterSelect = document.getElementById('semester');
                    semesterSelect.innerHTML = ''; // Clear existing options

                    // Add the default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Semester';
                    semesterSelect.appendChild(defaultOption);

                    // Add new options
                    data.semesters.forEach(semester => {
                        const option = document.createElement('option');
                        option.value = semester.ID;
                        option.textContent = semester.name;
                        semesterSelect.appendChild(option);
                    });

                    // Conditionally fetch courses if needed
                })
                .catch(error => {
                    console.error('Error fetching semesters:', error);
                    alert('An error occurred while fetching semesters');
                });
        }
    </script>
</main>

{{template "dashboard/layouts/bottom" .}}